if (document.readyState == 'interactive') {
    DynatraceBizEventPageInformation();
} else {
    document.addEventListener('DOMContentLoaded', DynatraceBizEventPageInformation());
}

function DynatraceBizEventPageInformation() {
    if (typeof dynatrace != 'undefined' && dynatrace && typeof dynatrace.sendBizEvent == 'function') {

        var uppercasePageType = (typeof PageType != 'undefined' && PageType) ? PageType : "";
        var lowercasePageType = (typeof pageType != 'undefined' && pageType) ? pageType : "";

        var dtAttributes = {
            "event.name": "Page Information",
            "client": "",
            "country": "",
            "language": "",
            "desktopMobile": "",
            "pageType": uppercasePageType ? uppercasePageType : lowercasePageType,
            "isApp": document.body.classList.contains("appMode"),
            "pageUrl": window.location.href.toLowerCase()
        };

        if (typeof Next != 'undefined' && Next) {
            // MVC & Auth0
            if (typeof Next.Settings != 'undefined' && Next.Settings && typeof Next.Settings.Channel != 'undefined' && Next.Settings.Channel) {
                dtAttributes.client = Next.Settings.Channel.EPMRealm ? Next.Settings.Channel.EPMRealm : "";
                dtAttributes.desktopMobile = Next.Settings.Channel.IsMobileSite ? "Mobile" : "Desktop";
                dtAttributes.country = Next.Settings.Channel.CountryName ? Next.Settings.Channel.CountryName : "";
                dtAttributes.language = Next.Settings.Channel.Language ? Next.Settings.Channel.Language : "";
            }

            // Auth0
            if (typeof Next.LoginPageSettings != 'undefined' && Next.LoginPageSettings) {
                dtAttributes.isApp = Next.LoginPageSettings.deviceType ? Next.LoginPageSettings.deviceType == "mobileApp" : false;
                dtAttributes.pageType = Next.LoginPageSettings.dynatracePageType ? Next.LoginPageSettings.dynatracePageType : "";
            }
        }

        if (dtAttributes.desktopMobile == "") {
            dtAttributes.desktopMobile = DynatraceGetCookie("NextDeviceType");
        }

        // Cloud
        if (dtAttributes.client == "") {
            dtAttributes.client = document.getElementById("cloud_realm") ? document.getElementById("cloud_realm").innerText : "";
        }
        if (dtAttributes.country == "") {
            dtAttributes.country = document.getElementById("cloud_territory") ? document.getElementById("cloud_territory").innerText : "";
        }
        if (dtAttributes.language == "") {
            dtAttributes.language = document.getElementById("cloud_language") ? document.getElementById("cloud_language").innerText : "";
        }
        if (dtAttributes.pageType == "" && typeof dataLayer != 'undefined' && dataLayer.length >= 1 && typeof dataLayer[0].page_type != "undefined") {
            dtAttributes.pageType = dataLayer[0].page_type ? dataLayer[0].page_type : "";
        }

        dynatrace.sendBizEvent('Business Funnel', dtAttributes);
    }
    else {
    }
}

function DynatraceGetCookie(cName) {
    if (document.cookie.length > 0) {
        var cStart = document.cookie.indexOf(cName + "=");
        if (cStart != -1) {
            cStart = cStart + cName.length + 1;
            var cEnd = document.cookie.indexOf(";", cStart);
            if (cEnd == -1) {
                cEnd = document.cookie.length;
            }
            return unescape(document.cookie.substring(cStart, cEnd));
        }
    }
    return "";
}